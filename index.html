<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual Therapy Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #setupScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        #setupScreen.hidden {
            display: none;
        }
        .setup-container {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #00ff00;
            text-align: center;
            max-width: 600px;
            width: 90%;
            margin: 20px 0;
        }
        .setup-container h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #00ff00;
        }
        .form-section {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: left;
        }
        .form-section label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 8px;
        }
        .form-section input[type="text"],
        .form-section input[type="number"],
        .form-section select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #666;
            border-radius: 5px;
            background: #1a1a1a;
            color: #fff;
            margin-bottom: 10px;
            -webkit-appearance: none;
            appearance: none;
        }
        .form-section select {
            cursor: pointer;
        }
        .form-section input:focus,
        .form-section select:focus {
            outline: none;
            border-color: #00ff00;
        }
        .error-message {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        .instructions {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: left;
        }
        .instructions p {
            font-size: 13px;
            line-height: 1.6;
            margin: 4px 0;
        }
        .participant-info {
            background: #1a3a1a;
            padding: 12px;
            border-radius: 5px;
            margin: 15px 0;
            border: 2px solid #00ff00;
        }
        .participant-info h3 {
            color: #00ff00;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .participant-info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
            border-bottom: 1px solid #2a4a2a;
        }
        .participant-info-row:last-child {
            border-bottom: none;
        }
        .participant-info-label {
            color: #888;
            font-weight: bold;
        }
        .participant-info-value {
            color: #00ff00;
            font-weight: bold;
        }
        #startBtn {
            margin-top: 20px;
            padding: 18px 50px;
            font-size: 20px;
            cursor: pointer;
            background: #00ff00;
            color: #000;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            width: 100%;
        }
        #startBtn:hover {
            background: #00cc00;
        }
        #startBtn:active {
            background: #009900;
        }
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            touch-action: none;
            position: fixed;
            top: 0;
            left: 0;
        }
        #stats {
            position: fixed;
            top: 5px;
            left: 5px;
            font-size: 12px;
            line-height: 1.2;
            background: rgba(0,0,0,0.85);
            padding: 5px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #00ff00;
            z-index: 10;
        }
        #stats > div {
            margin: 1px 0;
        }
        #controls {
            position: fixed;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .control-btn {
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid;
            border-radius: 5px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            transition: all 0.2s;
        }
        .control-btn.pause {
            border-color: #ffaa00;
            color: #ffaa00;
        }
        .control-btn.pause:active {
            background: #ffaa00;
            color: #000;
        }
        .control-btn.restart {
            border-color: #ff4444;
            color: #ff4444;
        }
        .control-btn.restart:active {
            background: #ff4444;
            color: #000;
        }
        #restartConfirm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 25px;
            border-radius: 10px;
            border: 3px solid #ff4444;
            text-align: center;
            display: none;
            z-index: 200;
            max-width: 400px;
            width: 90%;
        }
        #restartConfirm h3 {
            color: #ff4444;
            font-size: 22px;
            margin-bottom: 15px;
        }
        #restartConfirm p {
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        #restartConfirm button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            margin: 0 8px;
        }
        #restartConfirm .confirm-yes {
            background: #ff4444;
            color: #000;
        }
        #restartConfirm .confirm-no {
            background: #666;
            color: #fff;
        }
        #levelComplete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px;
            border-radius: 10px;
            border: 3px solid #00ff00;
            text-align: center;
            display: none;
            z-index: 100;
            max-width: 500px;
            width: 90%;
        }
        #sessionComplete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.98);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ffaa00;
            text-align: center;
            display: none;
            z-index: 100;
            max-width: 700px;
            width: 95%;
            max-height: 98vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .complete-title {
            font-size: 22px;
            margin-bottom: 10px;
            color: #00ff00;
        }
        .complete-info {
            font-size: 18px;
            margin: 10px 0;
        }
        .results-table {
            margin: 10px auto;
            background: #1a1a1a;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #00ff00;
        }
        .results-table h2 {
            color: #ffaa00;
            margin-bottom: 8px;
            font-size: 17px;
        }
        .results-table h3 {
            color: #00ff00;
            margin-top: 10px;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .results-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            margin: 3px 0;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 13px;
        }
        .results-label {
            color: #aaa;
            font-weight: bold;
        }
        .results-value {
            color: #00ff00;
            font-weight: bold;
        }
        .level-times-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        .level-time-box {
            background: #2a2a2a;
            padding: 5px;
            border-radius: 4px;
            font-size: 11px;
        }
        button.continue-btn {
            margin-top: 10px;
            padding: 12px 30px;
            font-size: 16px;
            cursor: pointer;
            background: #0066ff;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            width: 100%;
        }
        button.continue-btn:active {
            background: #0052cc;
        }
        button.continue-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        button.continue-btn.play-again {
            background: #00cc00;
            margin-top: 8px;
        }
        button.continue-btn.play-again:active {
            background: #009900;
        }
        .submit-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
            font-weight: bold;
            display: none;
        }
        .submit-status.success {
            background: #1a4d1a;
            color: #00ff00;
            border: 2px solid #00ff00;
            display: block;
        }
        .submit-status.error {
            background: #4d1a1a;
            color: #ff4444;
            border: 2px solid #ff4444;
            display: block;
        }
        .submit-status.sending {
            background: #4d4d1a;
            color: #ffaa00;
            border: 2px solid #ffaa00;
            display: block;
        }
        .info-note {
            margin-top: 10px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 5px;
            font-size: 10px;
            color: #888;
        }

        @media (max-height: 700px) {
            .complete-title {
                font-size: 18px !important;
                margin-bottom: 6px !important;
            }
            .participant-info {
                padding: 8px !important;
                margin: 6px 0 !important;
            }
            .participant-info h3 {
                font-size: 13px !important;
                margin-bottom: 5px !important;
            }
            .participant-info-row {
                padding: 3px 0 !important;
                font-size: 11px !important;
            }
            .results-table {
                margin: 6px auto !important;
                padding: 8px !important;
            }
            .results-table h2 {
                font-size: 15px !important;
                margin-bottom: 5px !important;
            }
            .results-row {
                padding: 4px 6px !important;
                margin: 2px 0 !important;
                font-size: 11px !important;
            }
            .level-times-grid {
                gap: 4px !important;
                margin: 6px 0 !important;
            }
            .level-time-box {
                padding: 4px !important;
                font-size: 10px !important;
            }
            .results-table h3 {
                font-size: 12px !important;
                margin-top: 6px !important;
                margin-bottom: 4px !important;
            }
            button.continue-btn {
                margin-top: 6px !important;
                padding: 10px 25px !important;
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <div id="setupScreen">
        <div class="setup-container">
            <h1>üéÆ Visual Therapy Game üéÆ</h1>
            
            <div class="instructions">
                <p><strong>üìã HOW TO PLAY:</strong></p>
                <p>üî¥ <strong>Catch LARGE RED balls</strong> = +10 points</p>
                <p>‚ö†Ô∏è <strong>Avoid small balls</strong> (red/blue) = -8 points</p>
                <p>üéØ Reach target score to advance ‚Ä¢ ‚è±Ô∏è Complete all 10 levels</p>
                <p></p>
                <p><strong>üéÆ CONTROLS:</strong> Mouse / Arrow Keys / A-D / Touch</p>
            </div>

            <div class="form-section">
                <label>Name: *</label>
                <input type="text" id="participantName" placeholder="Enter your name" required>
                <span class="error-message" id="nameError">Please enter your name</span>
            </div>

            <div class="form-section">
                <label>Age: *</label>
                <input type="number" id="participantAge" placeholder="Enter your age" min="1" max="120" required>
                <span class="error-message" id="ageError">Please enter a valid age</span>
            </div>

            <div class="form-section">
                <label>Gender: *</label>
                <select id="participantGender" required>
                    <option value="">-- Select Gender --</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
                <span class="error-message" id="genderError">Please select your gender</span>
            </div>

            <div class="form-section">
                <label>Eye Condition: *</label>
                <select id="participantEyeCondition" required>
                    <option value="">-- Select Eye Condition --</option>
                    <option value="Normal vision">Normal vision</option>
                    <option value="Reduced vision in one eye">Reduced vision in one eye</option>
                    <option value="Reduced vision in both eyes">Reduced vision in both eyes</option>
                    <option value="Uses glasses or contact lenses">Uses glasses or contact lenses</option>
                    <option value="Other vision difficulty">Other vision difficulty</option>
                    <option value="Prefer not to say/unsure">Prefer not to say/unsure</option>
                </select>
                <span class="error-message" id="eyeError">Please select your eye condition</span>
            </div>

            <div class="form-section">
                <label>Gaming Experience: *</label>
                <select id="participantGamingExp" required>
                    <option value="">-- Select Gaming Experience --</option>
                    <option value="Never">Never</option>
                    <option value="Rarely">Rarely</option>
                    <option value="Occasionally">Occasionally</option>
                    <option value="Regularly">Regularly</option>
                    <option value="Very frequently">Very frequently</option>
                </select>
                <span class="error-message" id="gamingError">Please select your gaming experience</span>
            </div>
            
            <button id="startBtn">START GAME</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="stats">
        <div>Level: <span id="level">1</span> / 10</div>
        <div>Score: <span id="score">0</span> / <span id="levelTarget">100</span></div>
        <div>Time: <span id="time">0</span>s</div>
        <div>Accuracy: <span id="accuracy">0</span>%</div>
    </div>

    <div id="controls">
        <button class="control-btn pause" onclick="togglePause()">‚è∏ PAUSE</button>
        <button class="control-btn restart" onclick="confirmRestart()">üîÑ RESTART</button>
    </div>

    <div id="levelComplete">
        <div class="complete-title">‚úÖ Level Complete!</div>
        <div class="complete-info">Time: <span id="levelTime">0</span>s</div>
        <div class="complete-info">Accuracy: <span id="levelAccuracy">0</span>%</div>
        <button class="continue-btn" onclick="nextLevel()">Continue to Next Level</button>
    </div>

    <div id="sessionComplete"></div>

    <div id="restartConfirm">
        <h3>‚ö†Ô∏è Restart Game?</h3>
        <p>Your current progress will be lost.<br>Start from Level 1?</p>
        <button class="confirm-yes" onclick="doRestart()">YES, RESTART</button>
        <button class="confirm-no" onclick="cancelRestart()">NO, CONTINUE</button>
    </div>

    <script>
        // ============================================
        // YOUR GOOGLE FORMS CONFIGURATION
        // ============================================
        const GOOGLE_FORM_CONFIG = {
            formUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSfvpfrnXuYUerJzffGDHwu5GLdgGpcNrOVvM3KvgLQ9jUEaXw/formResponse',
            fields: {
                name: 'entry.1602974697',
                age: 'entry.1437026270',
                gender: 'entry.1883590275',
                eyeCondition: 'entry.1868390671',
                gamingExp: 'entry.233817683',
                totalTime: 'entry.545269190',
                accuracy: 'entry.690791255',
                totalHits: 'entry.1643475158',
                totalMisses: 'entry.162174670',
                levelTimes: 'entry.1092669754',
                levelAccuracies: 'entry.1507752331'
            }
        };
        // ============================================

        const startBtn = document.getElementById('startBtn');
        const setupScreen = document.getElementById('setupScreen');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameState = {
            running: false,
            paused: false,
            level: 1,
            score: 0,
            time: 0,
            hits: 0,
            misses: 0,
            levelStartTime: 0,
            totalStartTime: 0,
            pausedTime: 0,
            pauseStartTime: 0,
            levelTimes: [],
            levelAccuracies: [],
            levelHits: [],
            levelMisses: []
        };

        const basket = {
            x: 0,
            y: 0,
            width: 65,
            height: 28,
            speed: 8
        };

        const participantInfo = {
            name: '',
            age: '',
            gender: '',
            eyeCondition: '',
            gamingExperience: ''
        };

        const balls = [];
        const keys = {};

        function resizeCanvas() {
            const safeHeight = window.innerHeight;
            canvas.width = window.innerWidth;
            canvas.height = safeHeight;
            basket.y = canvas.height * 0.85;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);

        startBtn.addEventListener('click', () => {
            if (validateForm()) {
                collectParticipantInfo();
                setupScreen.classList.add('hidden');
                startGame();
            }
        });

        function validateForm() {
            let isValid = true;
            const name = document.getElementById('participantName').value.trim();
            if (name === '') {
                document.getElementById('nameError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('nameError').style.display = 'none';
            }

            const age = document.getElementById('participantAge').value;
            if (age === '' || age < 1 || age > 120) {
                document.getElementById('ageError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('ageError').style.display = 'none';
            }

            const gender = document.getElementById('participantGender').value;
            if (gender === '') {
                document.getElementById('genderError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('genderError').style.display = 'none';
            }

            const eyeCondition = document.getElementById('participantEyeCondition').value;
            if (eyeCondition === '') {
                document.getElementById('eyeError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('eyeError').style.display = 'none';
            }

            const gamingExp = document.getElementById('participantGamingExp').value;
            if (gamingExp === '') {
                document.getElementById('gamingError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('gamingError').style.display = 'none';
            }

            return isValid;
        }

        function collectParticipantInfo() {
            participantInfo.name = document.getElementById('participantName').value.trim();
            participantInfo.age = document.getElementById('participantAge').value;
            participantInfo.gender = document.getElementById('participantGender').value;
            participantInfo.eyeCondition = document.getElementById('participantEyeCondition').value;
            participantInfo.gamingExperience = document.getElementById('participantGamingExp').value;
        }

        const LEVEL_CONFIG = {
            1: { target: 100, contrast: 0.7, largeBallSize: 28, smallBallSize: 9, speed: 3.0, spawnRate: 650, basketWidth: 65, distractorBonus: 0 },
            2: { target: 100, contrast: 0.65, largeBallSize: 27, smallBallSize: 9, speed: 3.3, spawnRate: 600, basketWidth: 65, distractorBonus: 0 },
            3: { target: 100, contrast: 0.6, largeBallSize: 26, smallBallSize: 9, speed: 3.6, spawnRate: 550, basketWidth: 65, distractorBonus: 0 },
            4: { target: 150, contrast: 0.55, largeBallSize: 25, smallBallSize: 9, speed: 4.0, spawnRate: 500, basketWidth: 65, distractorBonus: 0 },
            5: { target: 150, contrast: 0.5, largeBallSize: 24, smallBallSize: 10, speed: 4.4, spawnRate: 450, basketWidth: 67, distractorBonus: 0 },
            6: { target: 150, contrast: 0.48, largeBallSize: 23, smallBallSize: 10, speed: 4.8, spawnRate: 420, basketWidth: 67, distractorBonus: 0 },
            7: { target: 200, contrast: 0.45, largeBallSize: 22, smallBallSize: 10, speed: 5.2, spawnRate: 400, basketWidth: 67, distractorBonus: 0 },
            8: { target: 200, contrast: 0.42, largeBallSize: 21, smallBallSize: 10, speed: 5.6, spawnRate: 380, basketWidth: 69, distractorBonus: 1 },
            9: { target: 200, contrast: 0.4, largeBallSize: 20, smallBallSize: 11, speed: 6.0, spawnRate: 360, basketWidth: 69, distractorBonus: 1 },
            10: { target: 250, contrast: 0.5, largeBallSize: 20, smallBallSize: 11, speed: 6.5, spawnRate: 340, basketWidth: 70, distractorBonus: 2 }
        };

        function getLevelConfig() {
            return LEVEL_CONFIG[gameState.level];
        }

        function createBall(type) {
            const config = getLevelConfig();
            const radius = type === 'large' ? config.largeBallSize : config.smallBallSize;
            return {
                x: Math.random() * (canvas.width - radius * 2) + radius,
                y: -radius,
                radius: radius,
                type: type,
                speed: config.speed + Math.random() * 1.5,
                color: type === 'large' ? '#ff0000' : (Math.random() < 0.5 ? '#ff0000' : '#0000ff'),
                points: type === 'large' ? 10 : -8
            };
        }

        function drawBasket() {
            ctx.strokeStyle = '#0000ff';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(basket.x - basket.width/2, basket.y - basket.height/2);
            ctx.lineTo(basket.x - basket.width/2, basket.y + basket.height/2);
            ctx.lineTo(basket.x + basket.width/2, basket.y + basket.height/2);
            ctx.lineTo(basket.x + basket.width/2, basket.y - basket.height/2);
            ctx.stroke();
        }

        function drawBall(ball) {
            const config = getLevelConfig();
            ctx.globalAlpha = config.contrast;
            ctx.fillStyle = ball.color;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }

        function checkCollision(ball) {
            const ballBottom = ball.y + ball.radius;
            const ballTop = ball.y - ball.radius;
            const basketTop = basket.y - basket.height/2;
            const basketBottom = basket.y + basket.height/2;
            
            if (ballBottom < basketTop || ballTop > basketBottom) return false;
            
            const ballCenterX = ball.x;
            const basketLeft = basket.x - basket.width/2;
            const basketRight = basket.x + basket.width/2;
            const tolerance = ball.radius * 0.7;
            const effectiveLeft = basketLeft + tolerance;
            const effectiveRight = basketRight - tolerance;
            
            return (ballCenterX >= effectiveLeft) && (ballCenterX <= effectiveRight);
        }

        function updateBalls() {
            if (gameState.paused) return;
            
            for (let i = balls.length - 1; i >= 0; i--) {
                const ball = balls[i];
                ball.y += ball.speed;
                
                if (checkCollision(ball)) {
                    if (ball.type === 'large') {
                        gameState.score += 10;
                        gameState.hits++;
                    } else {
                        gameState.score = Math.max(0, gameState.score - 8);
                        gameState.misses++;
                    }
                    balls.splice(i, 1);
                    updateDisplay();
                    checkLevelComplete();
                    continue;
                }
                
                if (ball.y > canvas.height + 50) {
                    if (ball.type === 'large') gameState.misses++;
                    balls.splice(i, 1);
                }
            }
        }

        function updateBasket() {
            if (gameState.paused) return;
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                basket.x = Math.max(basket.width/2 + 5, basket.x - basket.speed);
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                basket.x = Math.min(canvas.width - basket.width/2 - 5, basket.x + basket.speed);
            }
        }

        function checkLevelComplete() {
            const config = getLevelConfig();
            if (gameState.score >= config.target) {
                completeLevel();
            }
        }

        function completeLevel() {
            gameState.running = false;
            gameState.paused = false;
            const levelTime = ((Date.now() - gameState.levelStartTime - gameState.pausedTime) / 1000).toFixed(1);
            const levelAccuracy = gameState.hits + gameState.misses > 0 
                ? Math.round((gameState.hits / (gameState.hits + gameState.misses)) * 100) 
                : 0;
            
            gameState.levelTimes.push(parseFloat(levelTime));
            gameState.levelAccuracies.push(levelAccuracy);
            gameState.levelHits.push(gameState.hits);
            gameState.levelMisses.push(gameState.misses);
            
            document.getElementById('levelTime').textContent = levelTime;
            document.getElementById('levelAccuracy').textContent = levelAccuracy;
            document.getElementById('levelComplete').style.display = 'block';
        }

        function nextLevel() {
            document.getElementById('levelComplete').style.display = 'none';
            
            if (gameState.level >= 10) {
                completeSession();
                return;
            }
            
            gameState.level++;
            gameState.score = 0;
            gameState.hits = 0;
            gameState.misses = 0;
            gameState.pausedTime = 0;
            
            const config = getLevelConfig();
            basket.width = config.basketWidth;
            
            gameState.levelStartTime = Date.now();
            balls.length = 0;
            lastSpawnTime = Date.now();
            gameState.running = true;
            gameState.paused = false;
            updateDisplay();
            updatePauseButton();
            gameLoop();
        }

        function completeSession() {
            gameState.running = false;
            gameState.paused = false;
            
            const totalTime = ((Date.now() - gameState.totalStartTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = (totalTime % 60).toFixed(1);
            
            let sumWeightedAccuracy = 0;
            let sumWeights = 0;
            for (let i = 0; i < gameState.levelAccuracies.length; i++) {
                const weight = i + 1;
                sumWeightedAccuracy += gameState.levelAccuracies[i] * weight;
                sumWeights += weight;
            }
            
            const weightedTotalAccuracy = Math.round(sumWeightedAccuracy / sumWeights);
            const totalHits = gameState.levelHits.reduce((sum, hits) => sum + hits, 0);
            const totalMisses = gameState.levelMisses.reduce((sum, misses) => sum + misses, 0);
            
            // Format level times as comma-separated: "20.4, 20.7, 18.8..."
            const levelTimesStr = gameState.levelTimes.join(', ');
            
            // Format level accuracies as comma-separated: "91, 79, 83..."
            const levelAccuraciesStr = gameState.levelAccuracies.join(', ');
            
            // Store results for submission
            window.resultsData = {
                name: participantInfo.name,
                age: participantInfo.age,
                gender: participantInfo.gender,
                eyeCondition: participantInfo.eyeCondition,
                gamingExperience: participantInfo.gamingExperience,
                totalTime: minutes + 'm ' + seconds + 's',
                accuracy: weightedTotalAccuracy,
                totalHits: totalHits,
                totalMisses: totalMisses,
                levelTimes: levelTimesStr,
                levelAccuracies: levelAccuraciesStr
            };
            
            // Build level times HTML
            let levelTimesHTML = '<div class="level-times-grid">';
            for (let i = 0; i < gameState.levelTimes.length; i++) {
                levelTimesHTML += '<div class="level-time-box">';
                levelTimesHTML += '<div style="color: #888; font-size: 11px;">L' + (i+1) + '</div>';
                levelTimesHTML += '<div style="color: #00ff00; font-weight: bold;">' + gameState.levelTimes[i] + 's</div>';
                levelTimesHTML += '<div style="color: #ffaa00; font-size: 11px;">Acc: ' + gameState.levelAccuracies[i] + '%</div>';
                levelTimesHTML += '</div>';
            }
            levelTimesHTML += '</div>';
            
            // Build results HTML
            let resultsHTML = '';
            resultsHTML += '<div class="complete-title">üéØ SESSION COMPLETE! üéØ</div>';
            resultsHTML += '<div class="participant-info">';
            resultsHTML += '<h3>üë§ PARTICIPANT INFO</h3>';
            resultsHTML += '<div class="participant-info-row"><span class="participant-info-label">Name:</span><span class="participant-info-value">' + participantInfo.name + '</span></div>';
            resultsHTML += '<div class="participant-info-row"><span class="participant-info-label">Age:</span><span class="participant-info-value">' + participantInfo.age + ' yrs</span></div>';
            resultsHTML += '<div class="participant-info-row"><span class="participant-info-label">Gender:</span><span class="participant-info-value">' + participantInfo.gender + '</span></div>';
            resultsHTML += '<div class="participant-info-row"><span class="participant-info-label">Eye:</span><span class="participant-info-value">' + participantInfo.eyeCondition + '</span></div>';
            resultsHTML += '<div class="participant-info-row"><span class="participant-info-label">Gaming:</span><span class="participant-info-value">' + participantInfo.gamingExperience + '</span></div>';
            resultsHTML += '</div>';
            resultsHTML += '<div class="results-table">';
            resultsHTML += '<h2>üìä RESULTS</h2>';
            resultsHTML += '<div class="results-row"><span class="results-label">Time:</span><span class="results-value">' + minutes + 'm ' + seconds + 's</span></div>';
            resultsHTML += '<div class="results-row" style="background: #3a3a00; border: 2px solid #ffaa00;"><span class="results-label">Accuracy:</span><span class="results-value" style="color: #ffaa00; font-size: 16px;">' + weightedTotalAccuracy + '%</span></div>';
            resultsHTML += '<div class="results-row"><span class="results-label">Hits:</span><span class="results-value">' + totalHits + '</span></div>';
            resultsHTML += '<div class="results-row"><span class="results-label">Misses:</span><span class="results-value">' + totalMisses + '</span></div>';
            resultsHTML += '<h3>‚è±Ô∏è Level Times & Accuracy:</h3>';
            resultsHTML += levelTimesHTML;
            resultsHTML += '<div id="submitStatus" class="submit-status"></div>';
            resultsHTML += '<button class="continue-btn play-again" onclick="location.reload()">üîÑ PLAY AGAIN</button>';
            resultsHTML += '</div>';
            
            document.getElementById('sessionComplete').innerHTML = resultsHTML;
            document.getElementById('sessionComplete').style.display = 'block';
            
            // Auto-submit to Google Forms after 1 second
            setTimeout(function() {
                submitToGoogleForms();
            }, 1000);
        }

        function submitToGoogleForms() {
            const statusDiv = document.getElementById('submitStatus');
            
            statusDiv.className = 'submit-status sending';
            statusDiv.textContent = '‚è≥ Submitting to Google Forms...';
            
            // Create iframe for submission
            const iframe = document.createElement('iframe');
            iframe.name = 'hidden_iframe';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            // Create form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_FORM_CONFIG.formUrl;
            form.target = 'hidden_iframe';
            
            // Add all form fields
            const fields = [
                { name: GOOGLE_FORM_CONFIG.fields.name, value: window.resultsData.name },
                { name: GOOGLE_FORM_CONFIG.fields.age, value: window.resultsData.age },
                { name: GOOGLE_FORM_CONFIG.fields.gender, value: window.resultsData.gender },
                { name: GOOGLE_FORM_CONFIG.fields.eyeCondition, value: window.resultsData.eyeCondition },
                { name: GOOGLE_FORM_CONFIG.fields.gamingExp, value: window.resultsData.gamingExperience },
                { name: GOOGLE_FORM_CONFIG.fields.totalTime, value: window.resultsData.totalTime },
                { name: GOOGLE_FORM_CONFIG.fields.accuracy, value: window.resultsData.accuracy },
                { name: GOOGLE_FORM_CONFIG.fields.totalHits, value: window.resultsData.totalHits },
                { name: GOOGLE_FORM_CONFIG.fields.totalMisses, value: window.resultsData.totalMisses },
                { name: GOOGLE_FORM_CONFIG.fields.levelTimes, value: window.resultsData.levelTimes },
                { name: GOOGLE_FORM_CONFIG.fields.levelAccuracies, value: window.resultsData.levelAccuracies }
            ];
            
            fields.forEach(function(field) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = field.name;
                input.value = field.value;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            
            console.log('Submitting data:', window.resultsData);
            
            form.submit();
            
            // Show success after 2 seconds
            setTimeout(function() {
                statusDiv.className = 'submit-status success';
                statusDiv.textContent = '‚úÖ Results submitted successfully to Google Forms!';
                
                // Clean up
                document.body.removeChild(form);
                document.body.removeChild(iframe);
            }, 2000);
        }

        function updateDisplay() {
            const config = getLevelConfig();
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('levelTarget').textContent = config.target;
            
            const currentTime = gameState.paused ? gameState.pauseStartTime : Date.now();
            const elapsedTime = currentTime - gameState.levelStartTime - gameState.pausedTime;
            document.getElementById('time').textContent = Math.floor(elapsedTime / 1000);
            
            const accuracy = gameState.hits + gameState.misses > 0 
                ? Math.round((gameState.hits / (gameState.hits + gameState.misses)) * 100) 
                : 0;
            document.getElementById('accuracy').textContent = accuracy;
        }

        function gameLoop() {
            if (!gameState.running) return;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (!gameState.paused) {
                updateBasket();
                updateBalls();
            }
            
            drawBasket();
            balls.forEach(ball => drawBall(ball));
            
            if (gameState.paused) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffaa00';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‚è∏ PAUSED', canvas.width / 2, canvas.height / 2);
            }
            
            requestAnimationFrame(gameLoop);
        }

        let lastSpawnTime = Date.now();
        function spawnBalls() {
            if (!gameState.running) {
                requestAnimationFrame(spawnBalls);
                return;
            }
            
            if (!gameState.paused) {
                const now = Date.now();
                const config = getLevelConfig();
                
                if (now - lastSpawnTime > config.spawnRate) {
                    const type = Math.random() < 0.35 ? 'large' : 'small';
                    balls.push(createBall(type));
                    
                    if (Math.random() < 0.4) {
                        balls.push(createBall('small'));
                    }
                    
                    for (let i = 0; i < config.distractorBonus; i++) {
                        if (Math.random() < 0.5) {
                            balls.push(createBall('small'));
                        }
                    }
                    lastSpawnTime = now;
                }
            }
            requestAnimationFrame(spawnBalls);
        }

        window.addEventListener('keydown', (e) => {
            const activeElement = document.activeElement;
            if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT') return;
            keys[e.key] = true;
            if (e.key === ' ' && gameState.running) togglePause();
            e.preventDefault();
        });
        
        window.addEventListener('keyup', (e) => {
            const activeElement = document.activeElement;
            if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT') return;
            keys[e.key] = false;
            e.preventDefault();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (gameState.running && !gameState.paused) basket.x = e.clientX;
        });

        canvas.addEventListener('touchmove', (e) => {
            if (gameState.running && !gameState.paused) {
                e.preventDefault();
                basket.x = e.touches[0].clientX;
            }
        }, { passive: false });

        canvas.addEventListener('touchstart', (e) => {
            if (gameState.running && !gameState.paused) {
                e.preventDefault();
                basket.x = e.touches[0].clientX;
            }
        }, { passive: false });

        setInterval(() => {
            if (gameState.running && !gameState.paused) updateDisplay();
        }, 100);

        function togglePause() {
            if (!gameState.running) return;
            gameState.paused = !gameState.paused;
            
            if (gameState.paused) {
                gameState.pauseStartTime = Date.now();
            } else {
                gameState.pausedTime += Date.now() - gameState.pauseStartTime;
                lastSpawnTime = Date.now();
            }
            updatePauseButton();
        }

        function updatePauseButton() {
            const pauseBtn = document.querySelector('.control-btn.pause');
            pauseBtn.textContent = gameState.paused ? '‚ñ∂ RESUME' : '‚è∏ PAUSE';
        }

        function confirmRestart() {
            if (!gameState.running) return;
            const wasPaused = gameState.paused;
            if (!wasPaused) togglePause();
            document.getElementById('restartConfirm').style.display = 'block';
        }

        function doRestart() {
            document.getElementById('restartConfirm').style.display = 'none';
            location.reload();
        }

        function cancelRestart() {
            document.getElementById('restartConfirm').style.display = 'none';
            if (gameState.paused && gameState.running) togglePause();
        }

        function startGame() {
            basket.x = canvas.width / 2;
            basket.y = canvas.height * 0.85;
            const config = getLevelConfig();
            basket.width = config.basketWidth;
            
            gameState.running = true;
            gameState.paused = false;
            gameState.pausedTime = 0;
            gameState.levelStartTime = Date.now();
            gameState.totalStartTime = Date.now();
            updateDisplay();
            updatePauseButton();
            gameLoop();
            spawnBalls();
        }
    </script>
</body>
</html>
